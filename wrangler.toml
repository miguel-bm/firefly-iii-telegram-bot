name = "firefly-telegram-bot"
main = "src/index.ts"
compatibility_date = "2024-12-30"
compatibility_flags = ["nodejs_compat"]

# Static assets for Telegram Web App
[assets]
directory = "./webapp/dist"
binding = "ASSETS"
run_worker_first = ["/telegram/*", "/api/*", "/healthz"]
not_found_handling = "single-page-application"

# Environment variables (non-secret)
[vars]
DEFAULT_CURRENCY = "EUR"
DEFAULT_ACCOUNT_ID = "151"
BOT_LANGUAGE = "es"           # "es" for Spanish, "en" for English
BOT_TIMEZONE = "Europe/Madrid"
MAX_HISTORY_MESSAGES = "20"   # Number of messages to keep in memory

# Cron job settings
ENABLE_MONTHLY_REPORT = "true"           # Send monthly report link on 1st of each month
BANK_IMPORT_REMINDER_DAYS = "10"         # Remind if no bank imports in N days

# Web App (dashboard) - Use t.me direct Mini App link format
# Set up via BotFather: /newapp -> select bot -> enter webapp URL -> get short name
# Set via: wrangler secret put DASHBOARD_WEBAPP_URL

# Secrets (set via `wrangler secret put <NAME>`):
# - TELEGRAM_BOT_TOKEN
# - TELEGRAM_WEBHOOK_SECRET
# - TELEGRAM_ALLOWED_CHAT_ID
# - FIREFLY_API_URL (e.g., https://firefly.yourdomain.com)
# - FIREFLY_API_TOKEN
# - OPENAI_API_KEY

# Durable Objects for Cloudflare Agents
[[durable_objects.bindings]]
name = "CHAT_AGENT"
class_name = "ChatAgentDO"

[[migrations]]
tag = "v1"
new_classes = ["ChatAgent"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["ChatAgentDO"]

# KV namespace for category cache
[[kv_namespaces]]
binding = "CATEGORY_CACHE"
id = "193a0c3a909d43b89b2e2b71564037cd"

# KV namespace for import hash deduplication
[[kv_namespaces]]
binding = "IMPORT_HASHES"
id = "d48b2421bb2b4242a7ba7b3e7a7acd3a"

# Cron triggers
[triggers]
crons = [
    "0 9 1 * *",   # Monthly report: 1st of month at 9:00 UTC
    "0 10 * * *"   # Daily bank import check: every day at 10:00 UTC
]

